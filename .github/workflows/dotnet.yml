on: [push, pull_request]
name: Continuous Integration

jobs:
  test:
    name: Test
    runs-on: ${{matrix.os.fullname}}
    strategy:
       fail-fast: false
       matrix:
         os:
            - { prettyname: Windows, fullname: windows-latest }
            - { prettyname: macOS, fullname: macos-latest }
            - { prettyname: Linux, fullname: ubuntu-latest }
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install .NET 6.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: "6.0.x"
    
    # https://github.com/ppy/osu-framework/issues/4349
    - name: Install libavformat-dev
      if: ${{matrix.os.fullname == 'ubuntu-latest'}}
      run: |
       sudo apt-get update && \
       sudo apt-get -y install libavformat-dev
    
    - name: Restore dependencies
      run: dotnet restore
    
    # Build on iOS is failes so we need to allow continue-on-error
    - name: Build
      continue-on-error: true
      run: |
        dotnet build -c Debug
    
    - name: Test
      run: dotnet test $pwd/*.Tests/bin/Debug/*/*.Tests.dll --logger "trx;LogFileName=TestResults-${{matrix.os.prettyname}}.trx"
      shell: pwsh
    
    # Attempt to upload results even if test fails.
    # https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#always
    - name: Upload Test Results
      uses: actions/upload-artifact@v2
      if: ${{ always() }}
      with:
        name: maisim-test-results-${{matrix.os.prettyname}}
        path: ${{github.workspace}}/TestResults/TestResults-${{matrix.os.prettyname}}.trx
